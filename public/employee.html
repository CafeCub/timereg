<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>Nhân viên</title>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css" integrity="sha384-PsH8R72JQ3SOdhVi3uxftmaW6Vc51MKb0q5P2rRUpPvrszuE4W1povHYgTpBfshb"
    crossorigin="anonymous">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css" integrity="sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp"
    crossorigin="anonymous">
  <link rel="stylesheet" href="/css/bootstrap-datepicker.min.css">
  <link rel="stylesheet" href="/css/custom.css">
</head>

<body>

  <nav class="navbar navbar-expand-lg navbar-dark bg-dark sticky-top" id="mainNav">
    <div class="container-fluid d-flex justify-content-between align-items-center">
      <a class="navbar-brand" href="employee-list.html">
        <i class="fa fa-arrow-left"></i>
      </a>
      <span class="text-white font-weight-bold text-center">Chi tiết nhân viên</span>
      <button class="btn btn-info btn-sm mr-2" onclick="calculatePayment();">
        <i class="fa fa-hand-holding-usd"></i>
        <span class="d-none d-sm-inline-block">Trả lương</span>
      </button>
    </div>
  </nav>

  <div id="employeeInfo" class="employee-detail-info">
    <div class="employee-info">
      <div id="sId" class="employee-id d-none">QMLsAre4fxN87uASwdA5</div>
      <div class="mb-1">
        <span class="employee-name lead font-weight-bold" id="sName">Nguyen Huu Trung</span>
        <button class="btn btn-link text-secondary btn-sm float-right edit-employee" onclick="editEmployeeDetail();">
          <i class="fas fa-edit"></i>
        </button>
        <button type="button" class="btn btn-link btn-sm text-secondary float-right mr-1" onclick="showHistoryPayment();">
          <i class="fas fa-history"></i>
        </button>
      </div>
      <div class="mb-1 small">
        <span class="employee-title font-weight-bold" id="sTitle">CEO</span>
        <span class="employee-isActived color-grey" id="sIsActived"></span>
      </div>
      <div class="mb-1 small">
        Bậc Lương:
        <span class="employee-rate font-weight-bold" id="sRate">10000</span>/h - Ngày lương:
        <span class="employee-insertedAt font-weight-bold" id="sLastPaymentDate">23/08/2016</span>
      </div>
      <hr>
      <div class="input-daterange input-group mb-2" id="PaymentDatepicker">
        <input type="text" class="input-sm form-control form-control-sm" name="start" />
        <span class="input-group-addon">to</span>
        <input type="text" class="input-sm form-control form-control-sm" name="end" />
        <button type="button" class="btn btn-info btn-sm btn-round-right">
          <i class="fa fa-calculator"></i>
          <span class="">Tính lương</span>
        </button>
      </div>

      <div class="mb-1 small">
        Giờ làm:
        <span class="employee-rate font-weight-bold" id="totalTime">230.5</span>h - Vi phạm:
        <span class="employee-insertedAt font-weight-bold" id="totalFee">100.000</span>
        - Thưởng:
        <span class="employee-insertedAt font-weight-bold" id="totalBonus">300.000</span>
        <br>
      </div>
      <div class="mb-1">
        Tổng lương:
        <span class="employee-insertedAt font-weight-bold" id="totalSalary">5.100.000</span>
      </div>

    </div>
  </div>
  <nav>
    <div class="nav nav-tabs nav-justified" id="submenu" role="tablist">
      <a class="nav-item nav-link active" id="nav-timereg-tab" data-toggle="tab" href="#nav-timereg" role="tab" aria-controls="nav-home"
        aria-selected="true" load-info="loadTimeReg(employee.id);">Chấm công</a>
      <a class="nav-item nav-link" id="nav-note-tab" data-toggle="tab" href="#nav-note" role="tab" aria-controls="nav-profile"
        aria-selected="false" load-info="loadNote(employee.id);">Ghi chú</a>
      <a class="nav-item nav-link" id="nav-bonus-tab" data-toggle="tab" href="#nav-bonus" role="tab" aria-controls="nav-contact"
        aria-selected="false" load-info="loadBonus(employee.id);">Thưởng</a>
    </div>
  </nav>

  <div class="tab-content" id="nav-tabsubmenu">
    <div class="tab-pane fade show active" id="nav-timereg" role="tabpanel" aria-labelledby="nav-timereg-tab">
      <div class="list-with-add-button">
        <table class="table table-bordered table-light table-sm" id="tblTimeReg">
          <thead class="thead-dark">
            <tr>
              <th scope="col">Ngày</th>
              <th scope="col">Giờ vào</th>
              <th scope="col">Giờ ra</th>
              <th scope="col">Tổng</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>16/08/2018</td>
              <td>07:30</td>
              <td>15:20</td>
              <td>08:30</td>
            </tr>
          </tbody>
        </table>
        <button type="button" class="btn btn-primary btn-lg floatbtn" onclick="addTimeReg();">
          <i class="fas fa-plus"></i>
        </button>
      </div>
    </div>
    <div class="tab-pane fade" id="nav-note" role="tabpanel" aria-labelledby="nav-note-tab">
      <div class="list-with-add-button">
        <table class="table table-bordered table-light table-sm" id="tblNote">
          <thead class="thead-dark">
            <tr>
              <th scope="col">Ngày</th>
              <th scope="col">Lí do</th>
              <th scope="col">Số Tiền</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>16/08/2018</th>
                <td>Bể ly trà đào</td>
                <td>30.000</td>
            </tr>
          </tbody>
        </table>
        <button type="button" class="btn btn-primary btn-lg floatbtn" onclick="addNote();">
          <i class="fas fa-plus"></i>
        </button>
      </div>
    </div>
    <div class="tab-pane fade" id="nav-bonus" role="tabpanel" aria-labelledby="nav-bonus-tab">
      <div class="list-with-add-button">
        <table class="table table-bordered table-light table-sm" id="tblBonus">
          <thead class="thead-dark">
            <tr>
              <th scope="col">Ngày</th>
              <th scope="col">Lí do</th>
              <th scope="col">Số Tiền</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>16/08/2018</th>
                <td>Nhiệt tình</td>
                <td>100.000</td>
            </tr>
          </tbody>
        </table>
        <button type="button" class="btn btn-primary btn-lg floatbtn" onclick="addBonus();">
          <i class="fas fa-plus"></i>
        </button>
      </div>
    </div>
  </div>

  <div id="historyPaymentModal" class="modal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Lịch sử trả lương</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <table class="small table table-bordered table-light table-sm table-responsive-md">
            <thead class="thead-dark">
              <tr>
                <th scope="col">#</th>
                <th scope="col">Từ Ngày - Đến ngày</th>
                <th scope="col">Giờ làm</th>
                <th scope="col">Vi phạm</th>
                <th scope="col">Thưởng</th>
                <th scope="col">Tổng lương</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>1</td>
                <td>16/05/2018
                  <br>31/05/2018</td>
                <td>350h</td>
                <td>500.000</td>
                <td>1.000.000</td>
                <td>3.500.000</td>
              </tr>
              <tr>
                <td>2</td>
                <td>16/05/2018
                  <br>31/05/2018</td>
                <td>350h</td>
                <td>500.000</td>
                <td>1.000.000</td>
                <td>3.500.000</td>
              </tr>
              <tr>
                <td>3</td>
                <td>16/05/2018
                  <br>31/05/2018</td>
                <td>350h</td>
                <td>500.000</td>
                <td>1.000.000</td>
                <td>3.500.000</td>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Đóng</button>
        </div>
      </div>
    </div>
  </div>

  <div id="confirmPaymentModal" class="modal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Xác nhận trả lương</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <p>Bạn đồng ý trả lương cho
            <br>
            <span class="font-weight-bold">Nhân viên
              <span class="name">xxx</span>
            </span>
            <br> Số tiền là
            <span class="font-weight-bold total">5.000.000 đ ?</span>
            <br> Vào ngày
            <span class="font-weight-bold date">16/06/2018</span>
          </p>
          <p>
            <i class="fas fa-exclamation-circle text-danger"></i> Ngày
            <span class="font-weight-bold date">16/06/2018</span> sẽ là ngày trả lương mới cho nhân viên này?</p>
          <p>
            Chi tiết: Số giờ làm việc:
            <span class="work-time"></span>h; Mức lương:
            <span class="rate"></span>; Thưởng:
            <span class="bonus"></span>; Ghi chú: -
            <span class="note"></span>
          </p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" onclick="confirmPayment();">Đồng ý</button>
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Bỏ qua</button>
        </div>
      </div>
    </div>
  </div>

  <div id="addBonusModal" class="modal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Thêm Thưởng</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <form>
            <div class="form-group mb-0">
              <input type="text" class="form-control-plaintext text-muted w-100" id="txtBonusId" placeholder="ID" readonly>
            </div>
            <div class="form-group mb-2">
              <label for="txtBonusDate">Ngày</label>
              <input type="text" class="form-control" id="txtBonusDate" placeholder="Ngày hiện tại" data-provide="datepicker">
            </div>
            <div class="form-group mb-2">
              <label for="txtBonusReason">Lí do</label>
              <input type="text" class="form-control" id="txtBonusReason" placeholder="Lí do">
            </div>
            <div class="form-group mb-2">
              <label for="txtBonusAmount">Số Tiền</label>
              <input type="number" class="form-control" id="txtBonusAmount" placeholder="Số Tiền">
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" onclick="saveBonus();">Lưu lại</button>
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Bỏ qua</button>
        </div>
      </div>
    </div>
  </div>

  <div id="addNoteModal" class="modal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Thêm Ghi chú</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <form>
            <div class="form-group mb-0">
              <input type="text" class="form-control-plaintext text-muted w-100" id="txtNoteId" placeholder="ID" readonly>
            </div>
            <div class="form-group mb-2">
              <label for="txtNoteDate">Ngày</label>
              <input type="text" class="form-control" id="txtNoteDate" placeholder="Ngày hiện tại" data-provide="datepicker">
            </div>
            <div class="form-group mb-2">
              <label for="txtNoteReason">Lí do</label>
              <input type="text" class="form-control" id="txtNoteReason" placeholder="Lí do">
            </div>
            <div class="form-group mb-2">
              <label for="txtNoteAmount">Số Tiền</label>
              <input type="number" class="form-control" id="txtNoteAmount" placeholder="Số Tiền">
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" onclick="saveNote();">Lưu lại</button>
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Bỏ qua</button>
        </div>
      </div>
    </div>
  </div>

  <div id="detailModal" class="modal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Chi tiết nhân viên</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <form>
            <div class="form-group mb-0">
              <input type="text" class="form-control-plaintext text-muted w-100" id="txtId" placeholder="ID" readonly>
            </div>
            <div class="form-group mb-2">
              <label for="txtName">Tên</label>
              <input type="text" class="form-control" id="txtName" placeholder="Name">
            </div>
            <div class="form-group mb-2">
              <label for="txtTitle">Chức danh</label>
              <input type="text" class="form-control" id="txtTitle" placeholder="Title">
            </div>
            <div class="form-group mb-2">
              <label for="txtRate">Bậc lương</label>
              <input type="number" class="form-control" id="txtRate" placeholder="Rate">
            </div>
            <div class="form-group mb-2">
              <label for="txtPaymentDate">Ngày lương</label>
              <input type="number" class="form-control" id="txtPaymentDate" placeholder="Payment Date">
            </div>
            <div class="form-check mb-2">
              <label class="form-check-label">
                <input type="checkbox" class="form-check-input" id="chbIsActived" checked="true"> Đang làm việc
              </label>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" onclick="saveDetail();">Lưu lại</button>
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Bỏ qua</button>
        </div>
      </div>
    </div>
  </div>

  <!-- update the version number as needed -->
  <script defer src="/__/firebase/5.0.4/firebase-app.js"></script>
  <!-- include only the Firebase features as you need -->
  <!-- <script defer src="/__/firebase/5.0.4/firebase-auth.js"></script> -->
  <!-- <script defer src="/__/firebase/5.0.4/firebase-database.js"></script> -->
  <!-- <script defer src="/__/firebase/5.0.4/firebase-messaging.js"></script> -->
  <!-- <script defer src="/__/firebase/5.0.4/firebase-storage.js"></script> -->
  <script defer src="/__/firebase/5.0.4/firebase-firestore.js"></script>
  <!-- initialize the SDK after all desired features are loaded -->
  <script defer src="/__/firebase/init.js"></script>
  <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
    crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.3/umd/popper.min.js" integrity="sha384-vFJXuSJphROIrBnz7yo7oB41mKfc8JzQZiCq4NCceLEaO4IHwicKwpJf9c9IpFgh"
    crossorigin="anonymous"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/js/bootstrap.min.js" integrity="sha384-alpBpkh1PFOepccYVYDB4do5UnbKysX5WZXm3XxPqe5iKTfUKjNkCk9SaVuEZflJ"
    crossorigin="anonymous"></script>
  <script defer src="/js/bootstrap-datepicker.min.js"></script>
  <script>
    $(document).ready(() => {
      $('#PaymentDatepicker').datepicker({});
      // $('#divHeader').load('header.html', () => {
      //   $("#navbarResponsive li.nav-item a.nav-link[href='/employee-list.html']").addClass("active");
      // });
      firebase.firestore().enablePersistence().then(function () {
        // Initialize Cloud Firestore through firebase
        db = firebase.firestore();
        initialize(db);
      }).catch(function (err) {
        console.warn("Cannot enable offline persistance");
        if (err.code == 'failed-precondition') {
          console.log("Multiple tabs open, persistence can only be enabled in one tab at a a time");
        } else if (err.code == 'unimplemented') {
          console.log("The current browser does not support all of the features required to enable persistence");
        }
        db = firebase.firestore();
        initialize(db);
      });
    });

    function initialize(db) {
      var eId = getUrlParameter("eId");
      if (eId) {
        db.collection("employees").doc(eId).get().then(function (doc) {
          if (doc.exists) {
            employee = $.extend(doc.data(), { id: eId });
            console.log("Document data:", employee);
            updateEmployeeData(employee);
          } else {
            // doc.data() will be undefined in this case
            console.log("No such document!");
          }
        }).catch(function (error) {
          console.log("Error getting document:", error);
        });
        loadTimeReg(eId);
      } else { alert("Invalid session, please go back to where you are!!!"); }
      $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
        $("div.tab-content tbody").empty();
        eval($(e.target).attr("load-info"));
      })
    }

    function loadTimeReg(eId) {
      db.collection("regTime").where("employeeId", "==", eId).get().then((docs) => {
        var records = [];
        docs.forEach((doc) => { records.push($.extend({ id: doc.id }, doc.data())) });
        records.sort((a, b) => { return a.startAt < b.startAt; });
        var htmlStr = "";
        records.forEach((r) => { htmlStr += '<tr trId="' + r.id + '"><td>' + toDateString(r.startAt) + '</td><td>' + toTimeString(r.startAt) + '</td><td>' + toTimeString(r.endAt) + '</td><td>' + getDurationString(r.endAt - r.startAt) + '</td></tr>'; });
        $("#tblTimeReg tbody").empty();
        $(htmlStr).appendTo("#tblTimeReg tbody");
      }).catch(function (error) { console.log("Error getting documents:", error); });
    }

    function loadNote(eId) {
      db.collection("notes").where("employeeId", "==", eId).get().then((docs) => {
        var records = [];
        docs.forEach((doc) => { records.push($.extend({ id: doc.id }, doc.data())) });
        records.sort((a, b) => { return (a.date || a.insertedAt) < (b.date || b.insertedAt); });
        var htmlStr = "";
        records.forEach((r) => { htmlStr += '<tr nId="' + r.id + '"><td>' + toDateString(r.date || r.insertedAt) + '</td><td>' + r.reason + '</td><td>' + toMoneyString(r.amount) + '</td></tr>'; });
        $("#tblNote tbody").empty();
        $(htmlStr).appendTo("#tblNote tbody");
      }).catch(function (error) { console.log("Error getting documents:", error); });
    }

    function loadBonus(eId) {
      db.collection("bonuses").where("employeeId", "==", eId).get().then((docs) => {
        var records = [];
        docs.forEach((doc) => { records.push($.extend({ id: doc.id }, doc.data())) });
        records.sort((a, b) => { return (a.date || a.insertedAt) < (b.date || b.insertedAt); });
        var htmlStr = "";
        records.forEach((r) => { htmlStr += '<tr nId="' + r.id + '"><td>' + toDateString(r.date || r.insertedAt) + '</td><td>' + r.reason + '</td><td>' + toMoneyString(r.amount) + '</td></tr>'; });
        $("#tblBonus tbody").empty();
        $(htmlStr).appendTo("#tblBonus tbody");
      }).catch(function (error) { console.log("Error getting documents:", error); });
    }

    function toTimeString(date) { return date ? date.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit', hour12: false }) : ""; }

    function toDateString(date) { return date ? date.toLocaleDateString('vi-VN') : ""; }

    function toMoneyString(amount) { return amount ? new Intl.NumberFormat('vi-VN').format(amount) : ""; }

    function getDurationString(milisecond) {
      if (milisecond) {
        var d = Math.floor(milisecond / 1000);
        var temp = d % 60;
        var result = ""//; = (temp > 9 ? temp.toString() : "0" + temp);
        temp = Math.floor(d / 60) % 60;
        if (temp == 0) { result = "00" + result; } else { result = (temp > 9 ? temp.toString() : "0" + temp) + result; }
        temp = Math.floor(d / 3600);
        if (temp == 0) { result = "00:" + result; } else { result = (temp > 9 ? temp.toString() : "0" + temp) + ":" + result; }
        return result;
      } else return "";
    }

    function editEmployeeDetail() {
      $('#txtId').val(employee.id);
      $('#txtName').val(employee.name);
      $('#txtRate').val(employee.rate);
      $('#txtTitle').val(employee.title);
      $('#chbIsActived').val(employee.isActived);
      $('#detailModal').modal({ focus: true });
    };

    function addBonus() {
      $("#txtBonusReason").val("");
      $("#txtBonusAmount").val("");
      $("#txtBonusDate").val("");
      $("#addBonusModal").modal({ focus: true })
    }

    function addNote() {
      $("#txtNoteReason").val("");
      $("#txtNoteAmount").val("");
      $("#txtNoteDate").val("");
      $("#addNoteModal").modal({ focus: true })
    }

    function getUrlParameter(name) {
      name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
      var regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
      var results = regex.exec(location.search);
      return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
    }

    function updateEmployeeData(e) {
      $("#sId").text(e.id);
      $("#sName").text(e.name);
      $("#sRate").text(e.rate);
      $("#sTitle").text(e.title);
      $("#sLastPaymentDate").text(toDateString(e.lastPaymentDate));
      $("#sIsActived").text(e.isActived ? "" : " - Đã nghỉ");
    }

    function saveDetail() {
      var id = employee.id;
      data = {
        name: $('#txtName').val(),
        rate: $('#txtRate').val(),
        title: $('#txtTitle').val(),
        isActived: $('#chbIsActived').prop("checked"),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      };
      db.collection("employees").doc(id).update(data).then(function (docRef) {
        console.log("Document update with ID: ", id);
        employee = $.extend(employee, data);
        updateEmployeeData(employee);
        $('#detailModal').modal('hide');
      }).catch(function (error) {
        console.error("Error adding document: ", error);
      });
    }

    function saveNote() {
      var id = employee.id;
      data = {
        employeeId: id,
        reason: $('#txtNoteReason').val(),
        amount: Number($('#txtNoteAmount').val()),
        date: $('#txtNoteDate').datepicker('getDate'),
        insertedAt: firebase.firestore.FieldValue.serverTimestamp()
      };
      db.collection("notes").add(data).then(function (docRef) {
        console.log("Document update with ID: ", docRef.id);
        employee = $.extend(employee, data);
        loadNote(id);
        $('#addNoteModal').modal('hide');
      }).catch(function (error) {
        console.error("Error adding document: ", error);
      });
    }

    function saveBonus() {
      var id = employee.id;
      data = {
        employeeId: id,
        reason: $('#txtBonusReason').val(),
        amount: Number($('#txtBonusAmount').val()),
        date: $('#txtBonusDate').datepicker('getDate'),
        insertedAt: firebase.firestore.FieldValue.serverTimestamp()
      };
      db.collection("bonuses").add(data).then(function (docRef) {
        console.log("Document update with ID: ", docRef.id);
        employee = $.extend(employee, data);
        loadBonus(id);
        $('#addBonusModal').modal('hide');
      }).catch(function (error) {
        console.error("Error adding document: ", error);
      });
    }

    function showHistoryPayment() {
      var id = employee.id;
      db.collection("payments").where("employeeId", "==", id).get().then((docs) => {
        var records = [];
        docs.forEach((doc) => { records.push($.extend({ id: doc.id }, doc.data())) });
        records.sort((a, b) => { return a.insertedAt < b.insertedAt; });
        var htmlStr = "";
        records.forEach((r, idx) => { htmlStr += '<tr phId="' + r.id + '"><td>' + (idx + 1) + '</td><td>' + toDateString(r.summary.fromDate) + '<br>' + toDateString(r.summary.toDate) + '</td><td>' + r.workHours + 'h</td><td>' + toMoneyString(r.summary.notesAmount) + '</td><td>' + toMoneyString(r.summary.bonusesAmount) + '</td><td>' + toMoneyString(r.total) + '</td></tr>'; });
        $("#historyPaymentModal tbody").empty();
        $(htmlStr).appendTo("#historyPaymentModal tbody");
        $("#historyPaymentModal").modal({ focus: true });
      }).catch(function (error) { console.log("Error getting documents:", error); });
    }

    function calculatePayment() {
      timeRegs = null; notes = null; bonuses = null; paymentHistory = null;
      var id = employee.id;
      db.collection("regTime").where("employeeId", "==", id).get().then((docs) => {
        var records = [];
        docs.forEach((doc) => { records.push($.extend({ id: doc.id }, doc.data())) });
        records.sort((a, b) => { return a.insertedAt < b.insertedAt; });
        timeRegs = records;
        showPaymentResult();
      }).catch(function (error) { console.log("Error getting documents:", error); });
      db.collection("notes").where("employeeId", "==", id).get().then((docs) => {
        var records = [];
        docs.forEach((doc) => { records.push($.extend({ id: doc.id }, doc.data())) });
        records.sort((a, b) => { return (a.date || a.insertedAt) < (b.date || b.insertedAt); });
        notes = records;
        showPaymentResult();
      }).catch(function (error) { console.log("Error getting documents:", error); });
      db.collection("bonuses").where("employeeId", "==", id).get().then((docs) => {
        var records = [];
        docs.forEach((doc) => { records.push($.extend({ id: doc.id }, doc.data())) });
        records.sort((a, b) => { return (a.date || a.insertedAt) < (b.date || b.insertedAt); });
        bonuses = records;
        showPaymentResult();
      }).catch(function (error) { console.log("Error getting documents:", error); });
    }

    function showPaymentResult() {
      if (timeRegs && notes && bonuses) {
        var workTime = 0, notesAmount = 0, bonusAmount = 0;
        timeRegs.forEach((r) => { if (r.endAt && r.startAt) { workTime += r.endAt - r.startAt; } });
        notes.forEach((r) => { notesAmount += r.amount; });
        bonuses.forEach((r) => { bonusAmount += r.amount; });
        workTime = Math.round(workTime / (10 * 3600)) / 100;
        var total = workTime * employee.rate + bonusAmount - notesAmount;
        $("#confirmPaymentModal span.name").text(employee.name);
        $("#confirmPaymentModal span.date").text(toDateString(new Date()));
        $("#confirmPaymentModal span.total").text(toMoneyString(total));
        $("#confirmPaymentModal span.work-time").text(workTime);
        $("#confirmPaymentModal span.rate").text(toMoneyString(employee.rate));
        $("#confirmPaymentModal span.bonus").text(toMoneyString(bonusAmount));
        $("#confirmPaymentModal span.note").text(toMoneyString(notesAmount));
        paymentHistory = {
          total: total,
          workHours: workTime,
          paidDate: firebase.firestore.FieldValue.serverTimestamp(),
          rate: employee.rate,
          employeeId: employee.id,
          summary: {
            bonusesAmount: bonusAmount,
            notesAmount: notesAmount,
            toDate: timeRegs.length > 0 ? timeRegs[0].startAt : firebase.firestore.FieldValue.serverTimestamp(),
            fromDate: timeRegs.length > 0 ? timeRegs[timeRegs.length - 1].startAt : firebase.firestore.FieldValue.serverTimestamp(),
            timeRegs: timeRegs,
            notes: notes,
            bonuses: bonuses
          }
        };
        $("#confirmPaymentModal").modal({ focus: true });
      }
    }

    function confirmPayment() {
      db.collection("payments").add(paymentHistory).then(function (docRef) {
        console.log("Document add with ID: ", docRef.id);
        var batch = db.batch();
        paymentHistory.summary.timeRegs.forEach((r) => { batch.delete(db.collection("regTime").doc(r.id)) });;
        batch.commit().then(function (docRef) {
          console.log("regTime documents are deleted");
        }).catch(function (error) {
          console.error("Error deleting regTime documents: ", error);
        });
        batch = db.batch();
        paymentHistory.summary.notes.forEach((r) => { batch.delete(db.collection("notes").doc(r.id)) });;
        batch.commit().then(function (docRef) {
          console.log("notes documents are deleted");
        }).catch(function (error) {
          console.error("Error deleting note documents: ", error);
        });
        batch = db.batch();
        paymentHistory.summary.bonuses.forEach((r) => { batch.delete(db.collection("bonuses").doc(r.id)) });;
        batch.commit().then(function (docRef) {
          console.log("bonus documents are deleted");
        }).catch(function (error) {
          console.error("Error deleting bonus documents: ", error);
        });
      }).catch(function (error) {
        console.error("Error adding document: ", error);
      });
    }
  </script>
</body>

</html>